const express = require('express');
const jwt = require('jsonwebtoken');
const app = express();

//바디파서

app.use(express.urlencoded({ extended: true }));
app.use(express.json());

let users = [
    { id: 0, data: "UserData"}              //배열안에 오브젝트
];

let buildingUnderConstuction  = null;       //시간 데이터를 저장한다. 
//let buildingUnderConstuction[10][10] + 오브젝트 형태가 들어가게

app.use(express.json());                   //json을 사용하겠다.


//====================== GAME LOGIC ===========================

app.post('/startConstruction' , (req, res) => {
    
    const currentTime = new Date();             //스타트시 const로 시간을 고정해준다. DB ->로 저장할때는 형태 결정해야함
    const constructionTime = new Date(currentTime.getTime() + 10000); //현재 시간으로부터 10초뒤로 저장(건물 완성 10초)
    buildingUnderConstuction = constructionTime;                //완성 시간을 전역으로

    let result = {                              //구조를 나중에 자세하게 설정
        message : buildingUnderConstuction
    };

    console.log(" SYSTEM : 건설 시작 ");

    res.send({                                  //기본 커맨드로 전송 
        cmd : 1101, 
        message : "SYSTEM : 건설 시작",
        result
    });
});

app.get('/checkConstruction' , (req, res) => {
    if(buildingUnderConstuction && new Date() >= buildingUnderConstuction)        //시간이 지났으면
    {
        buildingUnderConstuction = null;                                           //시간 초기화
        let result = {
            message : buildingUnderConstuction
        }
        console.log(" SYSTEM : 건설 완료 ");
        res.send ({                                  //기본 커맨드로 전송 
            cmd : 1101, 
            message : "SYSTEM : 건설 완료",
            result
        });
    }
    else    //설정한 시간 이전
    {
        let remainingTime = buildingUnderConstuction ? buildingUnderConstuction - new Date() : 0;
        remainingTime = Math.max(0 , remainingTime);    //음수 시간을 0으로 보정
        console.log("SYSTEM : 건설 중입니다 남은 시간은 " + remainingTime + " ms");
        let result = {
            message : remainingTime
        }
        res.send ({                                  //기본 커맨드로 전송 
            cmd : 1101, 
            message : "SYSTEM : 건설 중입니다",
            result
        });
    }
});




//================= GAME API ===========================
app.get('/',(req ,res)=>{

    let result = {
        cmd : -1,
        message : 'Hello world'
    };

    res.send(result);
});

app.get('/id',(req ,res)=>{

    let result = {
        cmd : 100,
        message : 'MyID'
    };

    res.send(result);
});

app.get('/userdata/list' , (req , res) => {         //유저 리스트 반환

    let result = users.sort(function(a,b){          //ID 순서로 정렬
            return b.id - a.id;
    });

    result = result.slice(0, users.length);         //유저 숫자만큼 배열 생성 0 ~ n-1

    res.send({                                      //패킷을 완성해서 보낸다. 
        cmd : 1101,
        message : '',
        result
    });

});

app.post('/userdata' , (req ,res) => {
    const{id, data} = req.body;                 //Reqest Body에 Json 데이터가 들어오면 id, data에 연결
    console.log(id,data);
    let result = {
        cmd: -1,
        message: ''
    };

    let user = users.find(x=>x.id == id);       //users 배열에서 X를 찾아서 리턴

    if(user == undefined)                       //undefined 될경우 신규 등록
    {
        users.push({id , data});                //배열에 입력 Push
        result.cmd = 1001;
        result.message = "유저 신규 등록";
    }
    else
    {
        console.log(id, user.data);
        user.data = data;
        result.cmd = 1002;
        result.message = '데이터 갱신';
    }

    console.log(users);
    res.send(result);

});

app.listen(3000, ()=> {
    console.log('server is running at 3000 port');
});
const mysql = require('mysql');

//MYSQL 연결 설정

const connection = mysql.createConnection({
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME,
});

const secretKey = 'secretkey';              //비밀 키 (반드시 보안);

function verifyToken(req, res, next)        //미들웨어 함수를 사용하여 토큰 검사
{
    const token = req.headers.authorization;        //클라이언트에서 해더에 토큰을 넣어서 보낸다.

    if(!token)
    {
        return res.status(403).json({message : 'No token provided'});
    }

    jwt.verify(token, secretKey, (err, decoded) => {
        if(err) 
        {
            return res.status(401).json({message: 'failed to authenticate token'});
        }
        req.decoded == decoded;
        next();
    });
}

app.post('/login', (req, res) => {
    const { userID, userPassword } = req.body;
    connection.query(`SELECT * FROM userid WHERE userID = '${userID}'`, (err, results, fields) => {
    if (err) throw err;

    if (results.length > 0) {
        // 조건에 맞는 레코드가 존재할 때
        console.log('리졸트 : ',results);
        console.log('리졸트 유저 패스워드 : ',results[0].userPassword);
        console.log('입력 패스워드 : ',userPassword);
        if(results[0].userPassword === userPassword)
        {
            const token = jwt.sign({username: results.username} , secretKey , { expiresIn: '1h' });
            console.log(token);
            res.status(200).json({token});
            console.log("패스워드 일치");
        }
        else
        {
            console.log('패스워드 불일치');
            return res.status(402).send({'Password Not Correct'})
        }
        console.log('데이터가 존재합니다.');
    } 
    else
    {
        // 조건에 맞는 레코드가 존재하지 않을 때
        console.log('데이터가 존재하지 않습니다.');
    }
});
});

app.post('/regist', (req, res) => {
    const { userID, userName, userPassword } = req.body;

    connection.query(`SELECT * FROM userid WHERE userID = '${userID}'`, (err, results, fields) => {
        if (err) 
        {
            console.error('중복 아이디 확인 중 오류 발생: ' + err);
            res.status(500).send('중복 아이디 확인 중 오류 발생');
        } 
        else {
            if (results.length > 0) 
            {
                res.status(400).send('중복된 아이디입니다. 다른 아이디를 선택해주세요.');
            } 
            else 
            {
                connection.query(`INSERT INTO userid (userID, userName, userPassword) VALUES ('${userID}', '${userName}', '${userPassword}')`, (err, results, fields) => {
                    if (err) 
                    {
                        console.error('회원가입 오류: ' + err);
                        res.status(500).send('회원가입 오류');
                    } else 
                    {
                        const dataArray = results;
                        console.log('회원가입 결과: ', dataArray);
                        res.send('회원가입 성공');
                    }
                });
            }
        }
    });
});
